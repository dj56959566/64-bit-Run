name: Build OneCloud ImmortalWrt with OpenClash

on:
  schedule:
    - cron: '0 16 * * *'   # 每日北京时间 00:00 自动检测更新
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Set Up Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl git tar zip jq

      - name: Check Latest OpenClash Version
        id: clash_ver
        run: |
          latest=$(curl -s https://api.github.com/repos/vernesong/OpenClash/releases/latest | jq -r .tag_name)
          echo "latest=$latest" >> $GITHUB_ENV
          echo "Latest OpenClash Version: $latest"

          if [ -f last_version.txt ]; then
            last=$(cat last_version.txt)
          else
            last="none"
          fi
          echo "Last Build Version: $last"

          if [ "$latest" = "$last" ]; then
            echo "No new version detected, skipping build."
            echo "skip_build=true" >> $GITHUB_ENV
          else
            echo "$latest" > last_version.txt
            echo "skip_build=false" >> $GITHUB_ENV
          fi

      - name: Stop if No New Version
        if: env.skip_build == 'true'
        run: exit 0

      - name: Download OpenClash Core
        run: |
          git clone --depth=1 -b core https://github.com/vernesong/OpenClash.git Meta
          mkdir -p openclash-x86 openclash-a53 openclash-a32

          find_extract() {
            local name=$1
            local target=$2
            core_path=$(find Meta -type f -name "$name" | head -n1)
            if [ -n "$core_path" ]; then
              echo "Extracting $core_path ..."
              tar -xzvf "$core_path" -C "$target"
            else
              echo "❌ Could not find $name"
              exit 1
            fi
          }

          find_extract "clash-linux-amd64-v1.tar.gz" "openclash-x86"
          find_extract "clash-linux-arm64.tar.gz" "openclash-a53"
          find_extract "clash-linux-armv7.tar.gz" "openclash-a32"

      - name: Package and Upload
        run: |
          mkdir -p output
          zip -r output/openclash-x86.zip openclash-x86
          zip -r output/openclash-a53.zip openclash-a53
          zip -r output/openclash-a32.zip openclash-a32
          ls -lh output

      - name: Delete Old Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete latest -y || true
          gh release delete ${{ env.latest }} -y || true

      - name: Create New Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ env.latest }} output/*.zip \
            --title "OpenClash Core ${{ env.latest }}" \
            --notes "Auto built by GitHub Actions on $(date '+%Y-%m-%d %H:%M:%S')"

