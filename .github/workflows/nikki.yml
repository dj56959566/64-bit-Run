#=================================================
# https://github.com/wukongdaily/RunFilesBuilder
# Description: Build nikki run files for OpenWrt 23.05+
# Lisence: MIT
# Author: wukongdaily
# Blog: wkdaily.cpolar.cn
#=================================================

name: Build nikki run files for 23.05+

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fetch latest release tag from nikki
        id: fetch_latest_tag
        run: |
          latest_tag=$(curl -s https://api.github.com/repos/nikkinikki-org/OpenWrt-nikki/releases/latest | jq -r '.tag_name')
          echo "LATEST_TAG=$latest_tag" >> $GITHUB_ENV

      - name: Clone makeself repository
        run: git clone https://github.com/megastep/makeself.git

      - name: Download latest nikki files (x86_64 / aarch64 / armv7)
        run: |
          ARCHS=("x86_64" "aarch64_cortex-a53" "arm_cortex-a7")

          echo "[+] Fetching release asset list..."
          assets=$(curl -s https://api.github.com/repos/nikkinikki-org/OpenWrt-nikki/releases/latest)
          [ -z "$assets" ] && echo "âŒ Failed to fetch release data" && exit 1

          for arch in "${ARCHS[@]}"; do
            echo "-----------------------------------------"
            echo "[*] Checking for ${arch} ..."
            url=$(echo "$assets" | jq -r ".assets[] | select(.name | test(\"nikki_${arch}-openwrt.*\\\\.tar\\\\.gz\")) | .browser_download_url")

            if [ -n "$url" ] && [ "$url" != "null" ]; then
              echo "[+] Found asset for ${arch}: $url"
              curl -L -o "nikki_${arch}-openwrt-24.10.tar.gz" "$url"
              tar --one-top-level="nikki_${arch}-openwrt-24.10" -xzf "nikki_${arch}-openwrt-24.10.tar.gz"
            else
              echo "[!] Warning: No release asset found for ${arch}"
            fi
          done

      - name: Organize extracted files
        run: |
          for arch in x86_64 aarch64_cortex-a53 arm_cortex-a7; do
            [ -d "nikki_${arch}-openwrt-24.10" ] || continue
            mkdir -p "nikki_${arch}"
            cp nikki_${arch}-openwrt-24.10/*.ipk nikki_${arch}/ 2>/dev/null || true

            # æ¸…ç†å¸¦ ~ çš„æ–‡ä»¶å
            pushd "nikki_${arch}" >/dev/null
            for file in *~*.ipk; do
              [ -e "$file" ] || continue
              mv "$file" "$(echo "$file" | tr -d '~')"
            done
            popd >/dev/null
          done

      - name: Create install.sh scripts
        run: |
          for arch in x86_64 aarch64_cortex-a53 arm_cortex-a7; do
            [ -d "nikki_${arch}" ] || continue
            cat <<'EOF' > "nikki_${arch}/install.sh"
            #!/bin/sh
            echo "[+] Updating opkg list..."
            opkg update
            if [ $? -ne 0 ]; then
                echo "[x] opkg update failed."
                exit 1
            fi
            echo "[+] Installing packages..."
            opkg install *.ipk
            echo "[âœ“] Install completed."
            EOF
            chmod +x "nikki_${arch}/install.sh"
          done

      - name: Move directories to makeself and pack
        run: |
          cd makeself
          for arch in x86_64 aarch64_cortex-a53 arm_cortex-a7; do
            [ -d "../nikki_${arch}" ] || continue
            mv ../nikki_${arch} .
            ./makeself.sh nikki_${arch}/ nikki_${{ env.LATEST_TAG }}_${arch}.run "nikki ${arch} auto installer" ./install.sh
          done

      - name: Check output
        run: |
          ls -lh makeself/nikki_*.run

      - name: Generate release notes
        run: |
          cat <<EOF > info.md
          ## nikki RunFiles - è‡ªåŠ¨æ„å»ºç‰ˆ
          **æ„å»ºæ¶æ„:** x86_64 / aarch64_cortex-a53 / arm_cortex-a7  
          **ç‰ˆæœ¬:** ${{ env.LATEST_TAG }}

          ---
          âœ… è‡ªåŠ¨æ£€æµ‹ nikki æœ€æ–°ç‰ˆæœ¬å¹¶ç”Ÿæˆ `.run` ä¸€é”®å®‰è£…åŒ…  
          ğŸ“¦ åŒ…å«é€‚é… OneCloud (ARMv7-A 32bit)  
          ğŸ”— åŸå§‹ä»“åº“: [nikkinikki-org/OpenWrt-nikki](https://github.com/nikkinikki-org/OpenWrt-nikki)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.1.0
        with:
          tag_name: ${{ env.LATEST_TAG }}
          name: "nikki-${{ env.LATEST_TAG }}"
          body_path: info.md
          files: makeself/nikki_*.run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
