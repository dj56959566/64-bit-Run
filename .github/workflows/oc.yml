name: Build OpenClash Installer

on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 * * *'   # æ¯å¤©åŒ—äº¬æ—¶é—´ 00:00 æ£€æŸ¥æ›´æ–°

jobs:
  check-update:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.check.outputs.new_version }}
      should_build: ${{ steps.check.outputs.should_build }}

    steps:
      - name: Check latest OpenClash version
        id: check
        run: |
          echo "ğŸ” æ£€æŸ¥ OpenClash æœ€æ–°ç‰ˆæœ¬å·..."
          latest=$(curl -s https://api.github.com/repos/vernesong/OpenClash/contents/version | jq -r '.download_url' | xargs curl -s | head -n1)
          echo "latest=$latest"
          echo "latest=$latest" >> $GITHUB_ENV
          
          # è·å–ä¸Šæ¬¡æ„å»ºè®°å½•çš„ç‰ˆæœ¬å·
          old=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/openclash-latest | jq -r '.name' | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || echo "none")

          echo "old=$old"

          if [ "$latest" != "$old" ] && [ "$latest" != "null" ]; then
            echo "ğŸŸ¢ æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬: $latest"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "new_version=$latest" >> $GITHUB_OUTPUT
          else
            echo "ğŸŸ¡ æ— æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ„å»º"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check-update
    if: needs.check-update.outputs.should_build == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4

      - name: Clone OpenClash luci feed
        run: |
          git clone -b package --depth=1 https://github.com/vernesong/OpenClash.git OpenClash

      - name: Clone Meta core
        run: |
          git clone -b master --depth=1 https://github.com/vernesong/OpenClash.git Meta

      - name: Prepare build directories
        run: |
          mkdir -p openclash-x86 openclash-a53 openclash-a32
          echo "version=${{ needs.check-update.outputs.new_version }}" >> $GITHUB_ENV

      - name: Copy luci-app-openclash
        run: |
          cp OpenClash/luci-app-openclash_*.ipk openclash-x86/ || true
          cp OpenClash/luci-app-openclash_*.ipk openclash-a53/ || true
          cp OpenClash/luci-app-openclash_*.ipk openclash-a32/ || true

      - name: Extract meta cores
        run: |
          tar -xzvf Meta/meta/clash-linux-amd64-v1.tar.gz -C openclash-x86
          tar -xzvf Meta/meta/clash-linux-arm64.tar.gz -C openclash-a53
          tar -xzvf Meta/meta/clash-linux-armv7.tar.gz -C openclash-a32
          mv openclash-x86/clash openclash-x86/clash_meta
          mv openclash-a53/clash openclash-a53/clash_meta
          mv openclash-a32/clash openclash-a32/clash_meta

      - name: Add install script
        run: |
          cat > install.sh <<'EOF'
          #!/bin/bash
          echo ">>> Installing OpenClash ..."
          mkdir -p /etc/openclash/core/
          cp clash_meta /etc/openclash/core/clash_meta
          chmod +x /etc/openclash/core/clash_meta
          opkg install luci-app-openclash_*.ipk
          echo ">>> OpenClash installation complete."
          EOF
          chmod +x install.sh

      - name: Clone makeself
        run: |
          git clone https://github.com/megastep/makeself.git
          chmod +x makeself/makeself.sh

      - name: Create self-extracting installers
        run: |
          ./makeself/makeself.sh openclash-x86 OpenClash_x86_64_${{ env.version }}.run "OpenClash ${{ env.version }} (x86_64)" ./install.sh
          ./makeself/makeself.sh openclash-a53 OpenClash_aarch64_${{ env.version }}.run "OpenClash ${{ env.version }} (ARMv8)" ./install.sh
          ./makeself/makeself.sh openclash-a32 OpenClash_armv7_${{ env.version }}.run "OpenClash ${{ env.version }} (ARMv7/Cortex-A5)" ./install.sh

      - name: Delete previous release and tag
        uses: dev-drprasad/delete-tag-and-release@v1.0
        with:
          tag_name: openclash-latest
          delete_release: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: openclash-latest
          name: "OpenClash v${{ env.version }} Auto Installer"
          files: |
            OpenClash_x86_64_${{ env.version }}.run
            OpenClash_aarch64_${{ env.version }}.run
            OpenClash_armv7_${{ env.version }}.run
          body: |
            âœ… è‡ªåŠ¨æ„å»ºçš„ OpenClash ä¸€é”®å®‰è£…åŒ…  
            æ”¯æŒå¹³å°ï¼š
            - x86_64  
            - ARMv8 (aarch64)  
            - ARMv7 / Cortex-A5 / OneCloud  
            ---
            å®‰è£…å‘½ä»¤ç¤ºä¾‹ï¼š
            ```bash
            chmod +x OpenClash_armv7_*.run
            ./OpenClash_armv7_*.run
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
